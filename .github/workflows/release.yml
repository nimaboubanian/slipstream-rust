name: Build Standalone Release Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux - Static MUSL build
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: slipstream-server
            asset_name: slipstream-server-linux-x64-static
            package: slipstream-server
          
          # Windows - Static build
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: slipstream-client.exe
            asset_name: slipstream-client-windows-x64-static
            package: slipstream-client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ===== LINUX BUILD =====
      - name: Install Linux MUSL dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake pkg-config musl-tools musl-dev
          
          # Install static OpenSSL for MUSL
          wget https://www.openssl.org/source/openssl-3.0.13.tar.gz
          tar xzf openssl-3.0.13.tar.gz
          cd openssl-3.0.13
          CC=musl-gcc ./Configure no-shared no-async --prefix=/usr/local/musl --openssldir=/usr/local/musl/ssl linux-x86_64
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build picoquic (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x scripts/build_picoquic.sh
          ./scripts/build_picoquic.sh

      - name: Set environment (Linux MUSL)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "OPENSSL_DIR=/usr/local/musl" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PICOQUIC_AUTO_BUILD=0" >> $GITHUB_ENV

      # ===== WINDOWS BUILD =====
      - name: Install Windows dependencies
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Install vcpkg for OpenSSL
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install
          .\vcpkg install openssl:x64-windows-static
          
      - name: Build picoquic (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Build picoquic using CMake on Windows
          $PICOQUIC_DIR = "$PWD\vendor\picoquic"
          $BUILD_DIR = "$PWD\.picoquic-build"
          
          # Configure with CMake
          cmake -S $PICOQUIC_DIR -B $BUILD_DIR `
            -DCMAKE_BUILD_TYPE=Release `
            -DPICOQUIC_FETCH_PTLS=ON `
            -A x64
          
          # Build
          cmake --build $BUILD_DIR --config Release

      - name: Set environment (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static" >> $env:GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "VCPKGRS_DYNAMIC=0" >> $env:GITHUB_ENV
          echo "RUSTFLAGS=-C target-feature=+crt-static" >> $env:GITHUB_ENV
          echo "PICOQUIC_AUTO_BUILD=0" >> $env:GITHUB_ENV
          echo "PICOQUIC_BUILD_DIR=$PWD\.picoquic-build" >> $env:GITHUB_ENV
          echo "PICOQUIC_DIR=$PWD\vendor\picoquic" >> $env:GITHUB_ENV

      # ===== RUST BUILD =====
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache vcpkg (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: ${{ runner.os }}-vcpkg-openssl-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Rust binary (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: cargo build --release --target ${{ matrix.target }} -p ${{ matrix.package }}

      - name: Build Rust binary (Windows)
        if: matrix.os == 'windows-latest'
        run: cargo build --release --target ${{ matrix.target }} -p ${{ matrix.package }}

      # ===== VERIFICATION =====
      - name: Verify static linking (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "=== Binary information ==="
          file target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          echo -e "\n=== Dynamic dependencies (should show none or just linux-vdso) ==="
          ldd target/${{ matrix.target }}/release/${{ matrix.artifact_name }} || echo "✓ Fully static binary!"

      - name: Verify binary (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "=== Binary information ==="
          Get-Item "target\${{ matrix.target }}\release\${{ matrix.artifact_name }}"

      # ===== PACKAGING =====
      - name: Create release package (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p release/slipstream-server
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} release/slipstream-server/
          strip release/slipstream-server/${{ matrix.artifact_name }}
          
          cat > release/slipstream-server/server.conf << 'EOF'
          # Slipstream Server Configuration
          DOMAIN=tunnel.example.com
          DNS_LISTEN_PORT=53
          TARGET_ADDRESS=127.0.0.1:5201
          CERT_PATH=./cert.pem
          KEY_PATH=./key.pem
          EOF
          
          cat > release/slipstream-server/start-server.sh << 'EOF'
          #!/bin/bash
          source server.conf
          ./slipstream-server \
            --dns-listen-port ${DNS_LISTEN_PORT} \
            --target-address ${TARGET_ADDRESS} \
            --domain ${DOMAIN} \
            --cert ${CERT_PATH} \
            --key ${KEY_PATH}
          EOF
          chmod +x release/slipstream-server/start-server.sh
          
          cat > release/slipstream-server/README.md << 'EOF'
          # Slipstream Server (Linux x64 - Fully Static)
          
          ✅ **Zero dependencies - runs on any x86_64 Linux**
          
          ## Quick Start
          1. Generate certificates (one-time):
             ```bash
             openssl req -x509 -newkey rsa:2048 -nodes \
               -keyout key.pem -out cert.pem -days 365 \
               -subj "/CN=slipstream"
             ```
          
          2. Edit `server.conf`:
             - DOMAIN: Your tunnel domain
             - DNS_LISTEN_PORT: 53 (requires root) or 8853 for testing
             - TARGET_ADDRESS: Where to forward traffic (e.g., 127.0.0.1:5201)
          
          3. Run the server:
             ```bash
             sudo ./start-server.sh
             ```
             (Use sudo if DNS_LISTEN_PORT=53)
          
          ## systemd Service (Optional)
          Create `/etc/systemd/system/slipstream.service`:
          ```ini
          [Unit]
          Description=Slipstream DNS Tunnel
          After=network.target
          
          [Service]
          Type=simple
          WorkingDirectory=/opt/slipstream
          ExecStart=/opt/slipstream/start-server.sh
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
          ```
          
          Then: `sudo systemctl enable --now slipstream`
          EOF
          
          cd release
          tar -czf slipstream-server-linux-x64-static.tar.gz slipstream-server/

      - name: Create release package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release/slipstream-client
          Copy-Item "target\${{ matrix.target }}\release\${{ matrix.artifact_name }}" "release\slipstream-client\"
          
          @'
          # Slipstream Client Configuration
          DOMAIN=tunnel.example.com
          RESOLVER=YOUR_SERVER_IP:53
          TCP_LISTEN_PORT=7000
          CONGESTION_CONTROL=dcubic
          # CERT_PATH=cert.pem
          # AUTHORITATIVE=false
          '@ | Out-File -FilePath "release\slipstream-client\client.conf" -Encoding UTF8
          
          @'
          @echo off
          setlocal EnableDelayedExpansion
          
          echo Loading Slipstream Client Configuration...
          echo.
          
          for /f "tokens=1,2 delims==" %%a in (client.conf) do (
              set "line=%%a"
              if "!line:~0,1!" NEQ "#" (
                  set "%%a=%%b"
              )
          )
          
          set "CMD=slipstream-client.exe --domain %DOMAIN% --resolver %RESOLVER% --tcp-listen-port %TCP_LISTEN_PORT%"
          
          if defined CERT_PATH (
              if exist "%CERT_PATH%" (
                  set "CMD=!CMD! --cert %CERT_PATH%"
                  echo Certificate pinning: ENABLED
              )
          )
          
          if defined CONGESTION_CONTROL (
              set "CMD=!CMD! --congestion-control %CONGESTION_CONTROL%"
          )
          
          if "%AUTHORITATIVE%"=="true" (
              set "CMD=!CMD! --authoritative"
              echo Authoritative mode: ENABLED
          )
          
          echo.
          echo Configuration:
          echo   Domain: %DOMAIN%
          echo   Resolver: %RESOLVER%
          echo   Listen Port: %TCP_LISTEN_PORT%
          echo   Congestion Control: %CONGESTION_CONTROL%
          echo.
          echo Starting Slipstream Client...
          echo.
          %CMD%
          '@ | Out-File -FilePath "release\slipstream-client\start-client.bat" -Encoding ASCII
          
          @'
          # Slipstream Client (Windows x64 - Fully Static)
          
          ✅ **Zero dependencies - No Visual C++ Redistributable needed**
          
          ## Quick Start
          
          1. **Configure** - Edit `client.conf`:
             ```
             DOMAIN=tunnel.example.com      # Must match server
             RESOLVER=1.2.3.4:53            # Your server IP and port
             TCP_LISTEN_PORT=7000           # Local listening port
             ```
          
          2. **Run** - Double-click `start-client.bat` or from command line:
             ```
             start-client.bat
             ```
          
          3. **Connect** - Configure your applications to use:
             - SOCKS5 Proxy: `127.0.0.1:7000`
          
          ## Testing Connection
          
          ```cmd
          curl --proxy socks5://127.0.0.1:7000 http://example.com
          ```
          
          ## Advanced Options
          
          ### Certificate Pinning (Recommended)
          1. Copy server's `cert.pem` to this folder
          2. Uncomment `CERT_PATH=cert.pem` in `client.conf`
          
          ### Authoritative Mode (High Performance)
          - Only use if you control the DNS resolver path
          - Uncomment `AUTHORITATIVE=true` in `client.conf`
          - Provides 2-3x better performance
          - Higher detection risk
          
          ### Congestion Control
          - `dcubic` (default): Balanced performance
          - `bbr`: Better for high-latency networks
          
          ## Firewall
          Windows Defender may prompt on first run. Allow network access.
          
          ## Troubleshooting
          - Verify `RESOLVER` IP is correct
          - Check server is running and accessible
          - Ensure port 7000 is not already in use
          - Try running as Administrator if needed
          '@ | Out-File -FilePath "release\slipstream-client\README.md" -Encoding UTF8
          
          Compress-Archive -Path "release\slipstream-client" -DestinationPath "release\slipstream-client-windows-x64-static.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            release/*.tar.gz
            release/*.zip

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
