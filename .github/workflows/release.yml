name: Build Standalone Release Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux Server (Static)
    runs-on: ubuntu-latest
    container:
      image: rust:alpine
    
    steps:
      - name: Install build dependencies
        run: |
          # Add edge repository for latest packages
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          
          apk update
          apk add --no-cache \
            git \
            cmake \
            make \
            gcc \
            g++ \
            musl-dev \
            linux-headers \
            openssl-dev \
            openssl-libs-static \
            pkgconfig \
            bash \
            perl \
            file \
            binutils

      - name: Verify tools
        run: |
          echo "=== Tool versions ==="
          cmake --version
          gcc --version | head -n1
          rustc --version

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build picoquic with CMake policy fix
        run: |
          ROOT_DIR="$PWD"
          PICOQUIC_DIR="${ROOT_DIR}/vendor/picoquic"
          BUILD_DIR="${ROOT_DIR}/.picoquic-build"
          BUILD_TYPE="Release"
          FETCH_PTLS="ON"
          
          echo "Building picoquic..."
          
          # Configure with CMAKE_POLICY_VERSION_MINIMUM flag
          cmake -S "${PICOQUIC_DIR}" -B "${BUILD_DIR}" \
            -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
            -DPICOQUIC_FETCH_PTLS="${FETCH_PTLS}" \
            -DCMAKE_POLICY_DEFAULT_CMP0000=NEW
          
          # Build
          cmake --build "${BUILD_DIR}"
          
          echo "âœ… Picoquic built successfully"

      - name: Set environment for static build
        run: |
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=/usr/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV
          echo "PICOQUIC_AUTO_BUILD=0" >> $GITHUB_ENV

      - name: Build server
        run: |
          echo "Building slipstream-server..."
          cargo build --release --target x86_64-unknown-linux-musl -p slipstream-server
          echo "âœ… Server built successfully"

      - name: Verify static linking
        run: |
          BINARY="target/x86_64-unknown-linux-musl/release/slipstream-server"
          
          echo "=== Binary information ==="
          file "$BINARY"
          
          echo ""
          echo "=== File size ==="
          ls -lh "$BINARY"
          
          echo ""
          echo "=== Checking dynamic dependencies ==="
          if ldd "$BINARY" 2>&1 | grep -q "not a dynamic executable"; then
            echo "âœ… SUCCESS: Fully static binary!"
          else
            echo "âš ï¸  Dynamic dependencies found:"
            ldd "$BINARY" || true
          fi
          
          echo ""
          echo "=== Stripping binary ==="
          strip "$BINARY"
          ls -lh "$BINARY"

      - name: Create release package
        run: |
          mkdir -p release/slipstream-server
          cp target/x86_64-unknown-linux-musl/release/slipstream-server release/slipstream-server/
          
          # Configuration file
          cat > release/slipstream-server/server.conf << 'EOF'
          # Slipstream Server Configuration
          DOMAIN=tunnel.example.com
          DNS_LISTEN_PORT=53
          TARGET_ADDRESS=127.0.0.1:5201
          CERT_PATH=./cert.pem
          KEY_PATH=./key.pem
          EOF
          
          # Startup script
          cat > release/slipstream-server/start-server.sh << 'EOF'
          #!/bin/bash
          set -e
          
          if [ ! -f server.conf ]; then
              echo "âŒ Error: server.conf not found"
              exit 1
          fi
          
          source server.conf
          
          echo "================================================"
          echo "  Slipstream DNS Tunnel Server"
          echo "================================================"
          echo ""
          echo "Configuration:"
          echo "  Domain      : ${DOMAIN}"
          echo "  DNS Port    : ${DNS_LISTEN_PORT}"
          echo "  Target      : ${TARGET_ADDRESS}"
          echo "  Certificate : ${CERT_PATH}"
          echo "  Private Key : ${KEY_PATH}"
          echo ""
          
          if [ ! -f "${CERT_PATH}" ] || [ ! -f "${KEY_PATH}" ]; then
              echo "âŒ Error: Certificate files not found"
              echo "   Run: ./generate-cert.sh"
              exit 1
          fi
          
          echo "Starting server..."
          echo "Press Ctrl+C to stop"
          echo ""
          
          ./slipstream-server \
            --dns-listen-port ${DNS_LISTEN_PORT} \
            --target-address ${TARGET_ADDRESS} \
            --domain ${DOMAIN} \
            --cert ${CERT_PATH} \
            --key ${KEY_PATH}
          EOF
          chmod +x release/slipstream-server/start-server.sh
          
          # Certificate generation script
          cat > release/slipstream-server/generate-cert.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Generating self-signed TLS certificate..."
          echo ""
          
          if ! command -v openssl &> /dev/null; then
              echo "âŒ Error: openssl command not found"
              echo ""
              echo "Install OpenSSL:"
              echo "  Ubuntu/Debian: sudo apt-get install openssl"
              echo "  CentOS/RHEL:   sudo yum install openssl"
              echo "  Alpine:        apk add openssl"
              exit 1
          fi
          
          openssl req -x509 -newkey rsa:2048 -nodes \
            -keyout key.pem -out cert.pem -days 365 \
            -subj "/CN=slipstream" \
            -addext "subjectAltName=DNS:tunnel.example.com,DNS:*.tunnel.example.com"
          
          chmod 600 key.pem
          chmod 644 cert.pem
          
          echo ""
          echo "âœ… Certificate generated successfully!"
          echo "   Files: cert.pem, key.pem"
          echo ""
          echo "âš ï¸  This is a self-signed certificate for testing only."
          EOF
          chmod +x release/slipstream-server/generate-cert.sh
          
          # README
          cat > release/slipstream-server/README.md << 'EOF'
          # Slipstream Server (Linux x86_64 - Fully Static)
          
          âœ… **Zero dependencies - Runs on ANY x86_64 Linux**
          
          ## Quick Start
          
          ```bash
          # 1. Generate certificates
          ./generate-cert.sh
          
          # 2. Edit configuration
          nano server.conf
          
          # 3. Run (port 53 requires root)
          sudo ./start-server.sh
          ```
          
          ## What You Need Installed
          
          ### To Run: NOTHING
          This is a fully static binary.
          
          ### To Generate Certificates (one-time): openssl command
          ```bash
          sudo apt-get install openssl  # Ubuntu/Debian
          sudo yum install openssl       # CentOS/RHEL
          apk add openssl               # Alpine
          ```
          
          ## Configuration
          
          Edit `server.conf`:
          - `DOMAIN`: Your tunnel domain
          - `DNS_LISTEN_PORT`: 53 (production) or 8853 (testing)
          - `TARGET_ADDRESS`: Forwarding destination
          
          ## Firewall
          
          ```bash
          sudo ufw allow 53/udp  # Ubuntu
          sudo firewall-cmd --permanent --add-port=53/udp  # CentOS/RHEL
          ```
          
          ## Testing
          
          ```bash
          dig @localhost -p 53 test.tunnel.example.com
          ```
          
          ## Full Documentation
          
          https://github.com/Mygod/slipstream-rust
          EOF
          
          # Create tarball
          cd release
          tar -czf slipstream-server-linux-x64-static.tar.gz slipstream-server/
          
          echo ""
          echo "=== Package created ==="
          ls -lh slipstream-server-linux-x64-static.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-server-linux-x64-static
          path: release/*.tar.gz

  build-windows:
    name: Build Windows Client (Static)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install vcpkg
        shell: pwsh
        run: |
          Write-Host "Installing vcpkg..."
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install

      - name: Install OpenSSL (static)
        shell: pwsh
        run: |
          Write-Host "Installing static OpenSSL..."
          cd C:\vcpkg
          .\vcpkg install openssl:x64-windows-static

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: windows-vcpkg-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: windows-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build picoquic
        shell: pwsh
        run: |
          $PICOQUIC_DIR = "$PWD\vendor\picoquic"
          $BUILD_DIR = "$PWD\.picoquic-build"
          
          Write-Host "Building picoquic..."
          
          # Configure with policy fix
          cmake -S $PICOQUIC_DIR -B $BUILD_DIR `
            -DCMAKE_BUILD_TYPE=Release `
            -DPICOQUIC_FETCH_PTLS=ON `
            -DCMAKE_POLICY_DEFAULT_CMP0000=NEW `
            -A x64
          
          # Build
          cmake --build $BUILD_DIR --config Release
          
          Write-Host "âœ… Picoquic built successfully"

      - name: Build client
        shell: pwsh
        env:
          OPENSSL_DIR: C:\vcpkg\installed\x64-windows-static
          OPENSSL_STATIC: "1"
          VCPKG_ROOT: C:\vcpkg
          VCPKGRS_DYNAMIC: "0"
          RUSTFLAGS: -C target-feature=+crt-static
          PICOQUIC_AUTO_BUILD: "0"
        run: |
          $env:PICOQUIC_BUILD_DIR = "$PWD\.picoquic-build"
          $env:PICOQUIC_DIR = "$PWD\vendor\picoquic"
          
          Write-Host "Building slipstream-client..."
          cargo build --release --target x86_64-pc-windows-msvc -p slipstream-client
          
          Write-Host "âœ… Client built successfully"

      - name: Verify build
        shell: pwsh
        run: |
          $binary = Get-Item "target\x86_64-pc-windows-msvc\release\slipstream-client.exe"
          Write-Host "Binary size: $([math]::Round($binary.Length / 1MB, 2)) MB"

      - name: Create release package
        shell: pwsh
        run: |
          Write-Host "Creating release package..."
          
          New-Item -ItemType Directory -Force -Path release\slipstream-client
          Copy-Item "target\x86_64-pc-windows-msvc\release\slipstream-client.exe" "release\slipstream-client\"
          
          @'
          # Slipstream Client Configuration
          DOMAIN=tunnel.example.com
          RESOLVER=YOUR_SERVER_IP:53
          TCP_LISTEN_PORT=7000
          CONGESTION_CONTROL=dcubic
          '@ | Out-File -FilePath "release\slipstream-client\client.conf" -Encoding UTF8
          
          @'
          @echo off
          setlocal EnableDelayedExpansion
          
          title Slipstream Client
          
          if not exist client.conf (
              echo Error: client.conf not found
              pause
              exit /b 1
          )
          
          for /f "tokens=1,2 delims==" %%a in (client.conf) do (
              set "line=%%a"
              if not "!line:~0,1!"=="#" if not "%%a"=="" set "%%a=%%b"
          )
          
          if "%RESOLVER%"=="YOUR_SERVER_IP:53" (
              echo Error: Configure RESOLVER in client.conf
              pause
              exit /b 1
          )
          
          echo Starting Slipstream Client...
          echo Domain: %DOMAIN%
          echo Resolver: %RESOLVER%
          echo Port: %TCP_LISTEN_PORT%
          echo.
          
          slipstream-client.exe --domain %DOMAIN% --resolver %RESOLVER% --tcp-listen-port %TCP_LISTEN_PORT% --congestion-control %CONGESTION_CONTROL%
          '@ | Out-File -FilePath "release\slipstream-client\start-client.bat" -Encoding ASCII
          
          @'
          # Slipstream Client (Windows x64 - Fully Static)
          
          âœ… **Zero dependencies - No VC++ Redistributable needed**
          
          ## Quick Start
          
          1. Edit `client.conf` - Set RESOLVER to your server IP
          2. Run `start-client.bat`
          3. Connect apps to SOCKS5: `127.0.0.1:7000`
          
          ## What You Need: NOTHING
          
          This is a fully static binary.
          
          ## Testing
          
          ```cmd
          curl --proxy socks5://127.0.0.1:7000 http://example.com
          ```
          
          https://github.com/Mygod/slipstream-rust
          '@ | Out-File -FilePath "release\slipstream-client\README.md" -Encoding UTF8
          
          Compress-Archive -Path "release\slipstream-client" -DestinationPath "release\slipstream-client-windows-x64-static.zip"
          
          Write-Host "âœ… Package created"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-client-windows-x64-static
          path: release/*.zip

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true
          body: |
            ## ğŸš€ Standalone Executables - Zero Dependencies
            
            **Linux Server**: Fully static MUSL binary - works on ANY x86_64 Linux
            **Windows Client**: Fully static binary - no VC++ Redistributable needed
            
            ### ğŸ“¦ Downloads
            - `slipstream-server-linux-x64-static.tar.gz`
            - `slipstream-client-windows-x64-static.zip`
            
            ### ğŸ”§ Quick Start
            1. Download and extract
            2. Edit configuration file
            3. Run startup script
            
            No installation or compilation required!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
