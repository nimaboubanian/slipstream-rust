name: Build Standalone Release Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux Server (Static)
    runs-on: ubuntu-latest
    container:
      image: rust:alpine
    
    steps:
      - name: Install build dependencies
        run: |
          # Add edge repository for latest CMake
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          
          apk update
          apk add --no-cache \
            git \
            cmake \
            make \
            gcc \
            g++ \
            musl-dev \
            linux-headers \
            openssl-dev \
            openssl-libs-static \
            pkgconfig \
            bash \
            perl

      - name: Verify CMake version
        run: |
          echo "=== CMake version ==="
          cmake --version

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Patch picotls CMake requirement
        run: |
          # Update the minimum CMake version requirement in picotls
          PICOTLS_CMAKE="vendor/picoquic/picotls/CMakeLists.txt"
          if [ -f "$PICOTLS_CMAKE" ]; then
            sed -i 's/CMAKE_MINIMUM_REQUIRED.*VERSION.*/CMAKE_MINIMUM_REQUIRED(VERSION 3.5)/' "$PICOTLS_CMAKE"
            echo "âœ“ Patched picotls CMakeLists.txt"
          else
            echo "âš  picotls CMakeLists.txt not found, will be fetched during build"
          fi

      - name: Build picoquic
        run: |
          chmod +x scripts/build_picoquic.sh
          # Set CMake policy to handle older versions
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          ./scripts/build_picoquic.sh

      - name: Set environment for static build
        run: |
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=/usr/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV
          echo "PICOQUIC_AUTO_BUILD=0" >> $GITHUB_ENV

      - name: Build server
        run: |
          cargo build --release --target x86_64-unknown-linux-musl -p slipstream-server

      - name: Verify static linking
        run: |
          echo "=== Binary information ==="
          file target/x86_64-unknown-linux-musl/release/slipstream-server
          echo ""
          echo "=== Checking dependencies ==="
          ldd target/x86_64-unknown-linux-musl/release/slipstream-server 2>&1 || echo "âœ“ Fully static binary!"
          echo ""
          echo "=== Binary size ==="
          ls -lh target/x86_64-unknown-linux-musl/release/slipstream-server

      - name: Create release package
        run: |
          mkdir -p release/slipstream-server
          cp target/x86_64-unknown-linux-musl/release/slipstream-server release/slipstream-server/
          strip release/slipstream-server/slipstream-server
          
          cat > release/slipstream-server/server.conf << 'EOF'
          # Slipstream Server Configuration
          DOMAIN=tunnel.example.com
          DNS_LISTEN_PORT=53
          TARGET_ADDRESS=127.0.0.1:5201
          CERT_PATH=./cert.pem
          KEY_PATH=./key.pem
          EOF
          
          cat > release/slipstream-server/start-server.sh << 'EOF'
          #!/bin/bash
          set -e
          
          if [ ! -f server.conf ]; then
              echo "Error: server.conf not found"
              exit 1
          fi
          
          source server.conf
          
          echo "================================================"
          echo "  Slipstream DNS Tunnel Server"
          echo "================================================"
          echo ""
          echo "Configuration:"
          echo "  Domain      : ${DOMAIN}"
          echo "  DNS Port    : ${DNS_LISTEN_PORT}"
          echo "  Target      : ${TARGET_ADDRESS}"
          echo "  Certificate : ${CERT_PATH}"
          echo "  Private Key : ${KEY_PATH}"
          echo ""
          echo "Starting server..."
          echo "Press Ctrl+C to stop"
          echo ""
          
          ./slipstream-server \
            --dns-listen-port ${DNS_LISTEN_PORT} \
            --target-address ${TARGET_ADDRESS} \
            --domain ${DOMAIN} \
            --cert ${CERT_PATH} \
            --key ${KEY_PATH}
          EOF
          chmod +x release/slipstream-server/start-server.sh
          
          cat > release/slipstream-server/generate-cert.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Generating self-signed TLS certificate..."
          echo ""
          
          if ! command -v openssl &> /dev/null; then
              echo "Error: openssl command not found"
              echo "Install: sudo apt-get install openssl (or equivalent)"
              exit 1
          fi
          
          openssl req -x509 -newkey rsa:2048 -nodes \
            -keyout key.pem -out cert.pem -days 365 \
            -subj "/CN=slipstream" \
            -addext "subjectAltName=DNS:tunnel.example.com,DNS:*.tunnel.example.com"
          
          chmod 600 key.pem
          chmod 644 cert.pem
          
          echo ""
          echo "âœ“ Certificate generated!"
          echo "  - cert.pem"
          echo "  - key.pem"
          EOF
          chmod +x release/slipstream-server/generate-cert.sh
          
          cat > release/slipstream-server/README.md << 'EOF'
          # Slipstream Server (Linux x86_64 Static)
          
          âœ… **Zero dependencies** - Works on any x86_64 Linux
          
          ## Quick Start
          
          1. **Generate certificates**:
             ```bash
             ./generate-cert.sh
             ```
          
          2. **Edit config**:
             ```bash
             nano server.conf
             ```
             Change `DOMAIN`, `DNS_LISTEN_PORT`, `TARGET_ADDRESS`
          
          3. **Run**:
             ```bash
             sudo ./start-server.sh
             ```
          
          ## What You Need Installed
          
          **To run the server**: NOTHING (fully static binary)
          
          **To generate certificates** (one-time): `openssl` command
          - Ubuntu/Debian: `sudo apt-get install openssl`
          - CentOS/RHEL: `sudo yum install openssl`
          - Alpine: `apk add openssl`
          
          ## Configuration
          
          Edit `server.conf`:
          - `DOMAIN`: Your tunnel domain
          - `DNS_LISTEN_PORT`: 53 (production) or 8853 (testing)
          - `TARGET_ADDRESS`: Where to forward traffic
          - `CERT_PATH`, `KEY_PATH`: Certificate files
          
          ## Firewall
          
          ```bash
          # Ubuntu/Debian
          sudo ufw allow 53/udp
          
          # CentOS/RHEL/Fedora
          sudo firewall-cmd --permanent --add-port=53/udp
          sudo firewall-cmd --reload
          ```
          
          ## Testing
          
          ```bash
          # Check if listening
          sudo netstat -ulnp | grep 53
          
          # Test DNS
          dig @localhost -p 53 test.tunnel.example.com
          ```
          
          ## Production (systemd)
          
          Create `/etc/systemd/system/slipstream.service`:
          ```ini
          [Unit]
          Description=Slipstream DNS Tunnel
          After=network.target
          
          [Service]
          Type=simple
          WorkingDirectory=/opt/slipstream
          ExecStart=/opt/slipstream/start-server.sh
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
          ```
          
          Then:
          ```bash
          sudo systemctl enable --now slipstream
          ```
          
          Full documentation: https://github.com/Mygod/slipstream-rust
          EOF
          
          cd release
          tar -czf slipstream-server-linux-x64-static.tar.gz slipstream-server/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-server-linux-x64-static
          path: release/*.tar.gz

  build-windows:
    name: Build Windows Client (Static)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install

      - name: Install OpenSSL (static)
        shell: pwsh
        run: |
          cd C:\vcpkg
          .\vcpkg install openssl:x64-windows-static

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: windows-vcpkg-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: windows-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build picoquic
        shell: pwsh
        run: |
          $PICOQUIC_DIR = "$PWD\vendor\picoquic"
          $BUILD_DIR = "$PWD\.picoquic-build"
          
          Write-Host "Building picoquic..."
          cmake -S $PICOQUIC_DIR -B $BUILD_DIR `
            -DCMAKE_BUILD_TYPE=Release `
            -DPICOQUIC_FETCH_PTLS=ON `
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 `
            -A x64
          
          cmake --build $BUILD_DIR --config Release
          
          Write-Host "âœ“ Picoquic built"

      - name: Build client
        shell: pwsh
        env:
          OPENSSL_DIR: C:\vcpkg\installed\x64-windows-static
          OPENSSL_STATIC: "1"
          VCPKG_ROOT: C:\vcpkg
          VCPKGRS_DYNAMIC: "0"
          RUSTFLAGS: -C target-feature=+crt-static
          PICOQUIC_AUTO_BUILD: "0"
        run: |
          $env:PICOQUIC_BUILD_DIR = "$PWD\.picoquic-build"
          $env:PICOQUIC_DIR = "$PWD\vendor\picoquic"
          
          cargo build --release --target x86_64-pc-windows-msvc -p slipstream-client

      - name: Create release package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release\slipstream-client
          Copy-Item "target\x86_64-pc-windows-msvc\release\slipstream-client.exe" "release\slipstream-client\"
          
          @'
          # Slipstream Client Configuration
          DOMAIN=tunnel.example.com
          RESOLVER=YOUR_SERVER_IP:53
          TCP_LISTEN_PORT=7000
          CONGESTION_CONTROL=dcubic
          '@ | Out-File -FilePath "release\slipstream-client\client.conf" -Encoding UTF8
          
          @'
          @echo off
          setlocal EnableDelayedExpansion
          
          title Slipstream Client
          
          if not exist client.conf (
              echo Error: client.conf not found
              pause
              exit /b 1
          )
          
          for /f "tokens=1,2 delims==" %%a in (client.conf) do (
              set "line=%%a"
              if not "!line:~0,1!"=="#" (
                  set "%%a=%%b"
              )
          )
          
          set "CMD=slipstream-client.exe --domain %DOMAIN% --resolver %RESOLVER% --tcp-listen-port %TCP_LISTEN_PORT% --congestion-control %CONGESTION_CONTROL%"
          
          echo Starting Slipstream Client...
          echo Domain: %DOMAIN%
          echo Resolver: %RESOLVER%
          echo Port: %TCP_LISTEN_PORT%
          echo.
          %CMD%
          '@ | Out-File -FilePath "release\slipstream-client\start-client.bat" -Encoding ASCII
          
          @'
          # Slipstream Client (Windows x64 Static)
          
          âœ… **Zero dependencies** - No VC++ Redistributable needed
          
          ## Quick Start
          
          1. **Edit** `client.conf`:
             - Set `RESOLVER` to your server IP
             - Set `DOMAIN` to match server
          
          2. **Run** `start-client.bat`
          
          3. **Connect** apps to SOCKS5: `127.0.0.1:7000`
          
          ## What You Need Installed
          
          **NOTHING!** This is a fully static binary.
          
          ## Testing
          
          ```cmd
          curl --proxy socks5://127.0.0.1:7000 http://example.com
          ```
          
          ## Browser Setup (Firefox)
          
          Settings â†’ Network â†’ Manual proxy:
          - SOCKS Host: `127.0.0.1`
          - Port: `7000`
          - SOCKS v5
          
          Full docs: https://github.com/Mygod/slipstream-rust
          '@ | Out-File -FilePath "release\slipstream-client\README.md" -Encoding UTF8
          
          Compress-Archive -Path "release\slipstream-client" -DestinationPath "release\slipstream-client-windows-x64-static.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-client-windows-x64-static
          path: release/*.zip

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true
          body: |
            ## ğŸ“¦ Standalone Binaries - Zero Dependencies
            
            ### Linux Server
            - `slipstream-server-linux-x64-static.tar.gz`
            - Fully static (MUSL libc)
            - Works on ANY x86_64 Linux distro
            
            ### Windows Client  
            - `slipstream-client-windows-x64-static.zip`
            - Fully static (no VC++ Runtime needed)
            - Windows 10/11 x64
            
            ### What You Need
            - **Linux**: Nothing (fully static)
            - **Windows**: Nothing (fully static)
            - **Certificates**: `openssl` command (one-time setup only)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
