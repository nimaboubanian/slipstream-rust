name: Build Standalone Release Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux Server (Static)
    runs-on: ubuntu-latest
    container:
      image: rust:alpine
    
    steps:
      - name: Install build dependencies
        run: |
          # Add edge repository for latest packages
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          
          apk update
          apk add --no-cache \
            git \
            cmake \
            make \
            gcc \
            g++ \
            musl-dev \
            linux-headers \
            openssl-dev \
            openssl-libs-static \
            pkgconfig \
            bash \
            perl \
            file \
            binutils

      - name: Verify tools
        run: |
          echo "=== Tool versions ==="
          cmake --version
          rustc --version
          cargo --version
          file --version

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Patch picotls CMake requirement
        run: |
          PICOTLS_CMAKE="vendor/picoquic/picotls/CMakeLists.txt"
          if [ -f "$PICOTLS_CMAKE" ]; then
            sed -i 's/CMAKE_MINIMUM_REQUIRED.*VERSION.*/CMAKE_MINIMUM_REQUIRED(VERSION 3.5)/' "$PICOTLS_CMAKE"
            echo "âœ“ Patched picotls CMakeLists.txt"
          fi

      - name: Build picoquic
        run: |
          chmod +x scripts/build_picoquic.sh
          ./scripts/build_picoquic.sh

      - name: Set environment for static build
        run: |
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=/usr/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV
          echo "PICOQUIC_AUTO_BUILD=0" >> $GITHUB_ENV

      - name: Build server
        run: |
          cargo build --release --target x86_64-unknown-linux-musl -p slipstream-server

      - name: Verify static linking
        run: |
          BINARY="target/x86_64-unknown-linux-musl/release/slipstream-server"
          
          echo "=== Binary information ==="
          file "$BINARY"
          
          echo ""
          echo "=== File size ==="
          ls -lh "$BINARY"
          
          echo ""
          echo "=== Checking dynamic dependencies ==="
          if ldd "$BINARY" 2>&1 | grep -q "not a dynamic executable"; then
            echo "âœ… SUCCESS: Fully static binary!"
          else
            echo "Dynamic dependencies found:"
            ldd "$BINARY" || true
          fi

      - name: Create release package
        run: |
          mkdir -p release/slipstream-server
          cp target/x86_64-unknown-linux-musl/release/slipstream-server release/slipstream-server/
          
          # Strip debug symbols to reduce size
          strip release/slipstream-server/slipstream-server
          
          echo "=== Stripped binary size ==="
          ls -lh release/slipstream-server/slipstream-server
          
          # Create configuration file
          cat > release/slipstream-server/server.conf << 'EOF'
          # Slipstream Server Configuration
          DOMAIN=tunnel.example.com
          DNS_LISTEN_PORT=53
          TARGET_ADDRESS=127.0.0.1:5201
          CERT_PATH=./cert.pem
          KEY_PATH=./key.pem
          EOF
          
          # Create startup script
          cat > release/slipstream-server/start-server.sh << 'EOF'
          #!/bin/bash
          set -e
          
          if [ ! -f server.conf ]; then
              echo "âŒ Error: server.conf not found"
              exit 1
          fi
          
          source server.conf
          
          echo "================================================"
          echo "  Slipstream DNS Tunnel Server"
          echo "================================================"
          echo ""
          echo "Configuration:"
          echo "  Domain      : ${DOMAIN}"
          echo "  DNS Port    : ${DNS_LISTEN_PORT}"
          echo "  Target      : ${TARGET_ADDRESS}"
          echo "  Certificate : ${CERT_PATH}"
          echo "  Private Key : ${KEY_PATH}"
          echo ""
          
          # Verify certificate files exist
          if [ ! -f "${CERT_PATH}" ] || [ ! -f "${KEY_PATH}" ]; then
              echo "âŒ Error: Certificate files not found"
              echo "   Run: ./generate-cert.sh"
              exit 1
          fi
          
          echo "Starting server..."
          echo "Press Ctrl+C to stop"
          echo ""
          
          ./slipstream-server \
            --dns-listen-port ${DNS_LISTEN_PORT} \
            --target-address ${TARGET_ADDRESS} \
            --domain ${DOMAIN} \
            --cert ${CERT_PATH} \
            --key ${KEY_PATH}
          EOF
          chmod +x release/slipstream-server/start-server.sh
          
          # Create certificate generation script
          cat > release/slipstream-server/generate-cert.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Generating self-signed TLS certificate..."
          echo ""
          
          if ! command -v openssl &> /dev/null; then
              echo "âŒ Error: openssl command not found"
              echo ""
              echo "Install OpenSSL:"
              echo "  Ubuntu/Debian: sudo apt-get install openssl"
              echo "  CentOS/RHEL:   sudo yum install openssl"
              echo "  Alpine:        apk add openssl"
              exit 1
          fi
          
          openssl req -x509 -newkey rsa:2048 -nodes \
            -keyout key.pem -out cert.pem -days 365 \
            -subj "/CN=slipstream" \
            -addext "subjectAltName=DNS:tunnel.example.com,DNS:*.tunnel.example.com"
          
          chmod 600 key.pem
          chmod 644 cert.pem
          
          echo ""
          echo "âœ… Certificate generated successfully!"
          echo "   Files: cert.pem, key.pem"
          echo ""
          echo "âš ï¸  This is a self-signed certificate for testing only."
          echo "   For production, use Let's Encrypt or a proper CA."
          EOF
          chmod +x release/slipstream-server/generate-cert.sh
          
          # Create README
          cat > release/slipstream-server/README.md << 'EOF'
          # Slipstream Server (Linux x86_64 - Fully Static)
          
          âœ… **Zero dependencies - Runs on ANY x86_64 Linux distribution**
          
          ## Quick Start (3 Steps)
          
          ### 1. Generate Certificates
          ```bash
          ./generate-cert.sh
          ```
          
          This creates `cert.pem` and `key.pem` for testing.
          
          ### 2. Configure
          Edit `server.conf`:
          ```bash
          nano server.conf
          ```
          
          Required settings:
          - `DOMAIN`: Your tunnel domain (e.g., `tunnel.example.com`)
          - `DNS_LISTEN_PORT`: `53` for production, `8853` for testing
          - `TARGET_ADDRESS`: Where to forward traffic (e.g., `127.0.0.1:5201`)
          
          ### 3. Run
          ```bash
          # Testing (non-privileged port)
          # Set DNS_LISTEN_PORT=8853 first
          ./start-server.sh
          
          # Production (requires root for port 53)
          sudo ./start-server.sh
          ```
          
          ## What You Need Installed
          
          ### To Run the Server
          **NOTHING!** This is a fully static binary.
          
          It will work on:
          - Ubuntu, Debian, Mint
          - CentOS, RHEL, Fedora, Rocky, Alma
          - Alpine, OpenSUSE, Arch
          - Amazon Linux, Oracle Linux
          - Any other x86_64 Linux distribution
          
          ### To Generate Certificates (One-Time)
          Only the `openssl` command:
          ```bash
          # Ubuntu/Debian
          sudo apt-get install openssl
          
          # CentOS/RHEL/Fedora
          sudo yum install openssl
          
          # Alpine
          apk add openssl
          ```
          
          ## Firewall Configuration
          
          Allow UDP port 53:
          ```bash
          # Ubuntu/Debian (UFW)
          sudo ufw allow 53/udp
          
          # CentOS/RHEL/Fedora (firewalld)
          sudo firewall-cmd --permanent --add-port=53/udp
          sudo firewall-cmd --reload
          
          # iptables
          sudo iptables -A INPUT -p udp --dport 53 -j ACCEPT
          ```
          
          ## Testing
          
          Check if server is listening:
          ```bash
          sudo netstat -ulnp | grep 53
          # or
          sudo ss -ulnp | grep 53
          ```
          
          Test DNS resolution:
          ```bash
          dig @localhost -p 53 test.tunnel.example.com
          ```
          
          ## Production Setup (systemd)
          
          1. Copy to system location:
          ```bash
          sudo mkdir -p /opt/slipstream
          sudo cp -r * /opt/slipstream/
          ```
          
          2. Create systemd service `/etc/systemd/system/slipstream.service`:
          ```ini
          [Unit]
          Description=Slipstream DNS Tunnel Server
          After=network.target
          
          [Service]
          Type=simple
          WorkingDirectory=/opt/slipstream
          ExecStart=/opt/slipstream/start-server.sh
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          ```
          
          3. Enable and start:
          ```bash
          sudo systemctl daemon-reload
          sudo systemctl enable slipstream
          sudo systemctl start slipstream
          sudo systemctl status slipstream
          ```
          
          ## Troubleshooting
          
          **Port 53 requires root**:
          ```bash
          sudo ./start-server.sh
          ```
          
          **Certificate errors**:
          ```bash
          # Verify files exist
          ls -l cert.pem key.pem
          
          # Regenerate if needed
          ./generate-cert.sh
          ```
          
          **View logs** (if using systemd):
          ```bash
          sudo journalctl -u slipstream -f
          ```
          
          ## Architecture
          
          - **Fully static binary** (MUSL libc)
          - **Static OpenSSL 3.x**
          - **Static picoquic/picotls**
          - **No dependencies required**
          
          File size: ~8-10MB (stripped)
          
          ## Links
          
          - Project: https://github.com/Mygod/slipstream-rust
          - Issues: https://github.com/Mygod/slipstream-rust/issues
          EOF
          
          # Create tarball
          cd release
          tar -czf slipstream-server-linux-x64-static.tar.gz slipstream-server/
          
          echo ""
          echo "=== Package created ==="
          ls -lh slipstream-server-linux-x64-static.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-server-linux-x64-static
          path: release/*.tar.gz

  build-windows:
    name: Build Windows Client (Static)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install vcpkg
        shell: pwsh
        run: |
          Write-Host "Installing vcpkg..."
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install

      - name: Install OpenSSL (static)
        shell: pwsh
        run: |
          Write-Host "Installing static OpenSSL..."
          cd C:\vcpkg
          .\vcpkg install openssl:x64-windows-static

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: windows-vcpkg-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: windows-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build picoquic
        shell: pwsh
        run: |
          $PICOQUIC_DIR = "$PWD\vendor\picoquic"
          $BUILD_DIR = "$PWD\.picoquic-build"
          
          Write-Host "Building picoquic..."
          cmake -S $PICOQUIC_DIR -B $BUILD_DIR `
            -DCMAKE_BUILD_TYPE=Release `
            -DPICOQUIC_FETCH_PTLS=ON `
            -A x64
          
          cmake --build $BUILD_DIR --config Release
          
          Write-Host "âœ… Picoquic built successfully"

      - name: Build client
        shell: pwsh
        env:
          OPENSSL_DIR: C:\vcpkg\installed\x64-windows-static
          OPENSSL_STATIC: "1"
          VCPKG_ROOT: C:\vcpkg
          VCPKGRS_DYNAMIC: "0"
          RUSTFLAGS: -C target-feature=+crt-static
          PICOQUIC_AUTO_BUILD: "0"
        run: |
          $env:PICOQUIC_BUILD_DIR = "$PWD\.picoquic-build"
          $env:PICOQUIC_DIR = "$PWD\vendor\picoquic"
          
          Write-Host "Building client..."
          cargo build --release --target x86_64-pc-windows-msvc -p slipstream-client
          
          Write-Host "âœ… Client built successfully"

      - name: Verify build
        shell: pwsh
        run: |
          $binary = Get-Item "target\x86_64-pc-windows-msvc\release\slipstream-client.exe"
          Write-Host "=== Binary Info ==="
          Write-Host "Size: $([math]::Round($binary.Length / 1MB, 2)) MB"
          Write-Host "Path: $($binary.FullName)"

      - name: Create release package
        shell: pwsh
        run: |
          Write-Host "Creating release package..."
          
          New-Item -ItemType Directory -Force -Path release\slipstream-client
          Copy-Item "target\x86_64-pc-windows-msvc\release\slipstream-client.exe" "release\slipstream-client\"
          
          @'
          # Slipstream Client Configuration
          DOMAIN=tunnel.example.com
          RESOLVER=YOUR_SERVER_IP:53
          TCP_LISTEN_PORT=7000
          CONGESTION_CONTROL=dcubic
          '@ | Out-File -FilePath "release\slipstream-client\client.conf" -Encoding UTF8
          
          @'
          @echo off
          setlocal EnableDelayedExpansion
          
          title Slipstream DNS Tunnel Client
          
          if not exist client.conf (
              echo Error: client.conf not found
              pause
              exit /b 1
          )
          
          echo ================================================
          echo   Slipstream DNS Tunnel Client
          echo ================================================
          echo.
          
          for /f "tokens=1,2 delims==" %%a in (client.conf) do (
              set "line=%%a"
              if not "!line:~0,1!"=="#" if not "%%a"=="" (
                  set "%%a=%%b"
              )
          )
          
          if "%DOMAIN%"=="" (
              echo Error: DOMAIN not configured in client.conf
              pause
              exit /b 1
          )
          
          if "%RESOLVER%"=="YOUR_SERVER_IP:53" (
              echo Error: Please configure RESOLVER in client.conf
              pause
              exit /b 1
          )
          
          set "CMD=slipstream-client.exe --domain %DOMAIN% --resolver %RESOLVER% --tcp-listen-port %TCP_LISTEN_PORT% --congestion-control %CONGESTION_CONTROL%"
          
          echo Configuration:
          echo   Domain     : %DOMAIN%
          echo   Resolver   : %RESOLVER%
          echo   Local Port : %TCP_LISTEN_PORT%
          echo   Algorithm  : %CONGESTION_CONTROL%
          echo.
          echo Starting client...
          echo Connect apps to: 127.0.0.1:%TCP_LISTEN_PORT%
          echo Press Ctrl+C to stop
          echo.
          
          %CMD%
          '@ | Out-File -FilePath "release\slipstream-client\start-client.bat" -Encoding ASCII
          
          @'
          # Slipstream Client (Windows x64 - Fully Static)
          
          âœ… **Zero dependencies - No VC++ Redistributable required**
          
          ## Quick Start
          
          1. **Edit** `client.conf`:
             - Change `RESOLVER` to your server's IP address
             - Change `DOMAIN` to match your server
          
          2. **Run** `start-client.bat`
          
          3. **Connect** your applications to SOCKS5 proxy: `127.0.0.1:7000`
          
          ## What You Need Installed
          
          **NOTHING!** This is a fully static binary with no dependencies.
          
          Works on:
          - Windows 10 (x64)
          - Windows 11 (x64)
          - Windows Server 2016+ (x64)
          
          ## Testing
          
          ```cmd
          curl --proxy socks5://127.0.0.1:7000 http://example.com
          ```
          
          ## Browser Setup
          
          **Firefox**:
          1. Settings â†’ Network Settings
          2. Manual proxy configuration
          3. SOCKS Host: `127.0.0.1`, Port: `7000`
          4. SOCKS v5
          
          **Chrome** (use SwitchyOmega extension)
          
          ## Firewall
          
          Windows Defender Firewall may prompt on first run.
          Click "Allow access" for the networks you want to use.
          
          ## Troubleshooting
          
          **"DOMAIN not configured"**: Edit client.conf
          
          **Connection timeout**: Check server IP in RESOLVER
          
          **Port in use**: Change TCP_LISTEN_PORT in client.conf
          
          ## Links
          
          Project: https://github.com/Mygod/slipstream-rust
          '@ | Out-File -FilePath "release\slipstream-client\README.md" -Encoding UTF8
          
          Compress-Archive -Path "release\slipstream-client" -DestinationPath "release\slipstream-client-windows-x64-static.zip"
          
          Write-Host "âœ… Package created"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-client-windows-x64-static
          path: release/*.zip

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true
          body: |
            ## ğŸš€ Slipstream Rust - Standalone Executables
            
            ### âœ… Zero Dependencies Required
            
            **Linux Server** (`slipstream-server-linux-x64-static.tar.gz`):
            - Fully static MUSL binary
            - Works on ANY x86_64 Linux distro
            - No glibc, OpenSSL, or other libraries needed
            
            **Windows Client** (`slipstream-client-windows-x64-static.zip`):
            - Fully static binary
            - No Visual C++ Redistributable needed
            - Works on Windows 10/11 x64
            
            ### ğŸ“¦ What's Included
            
            Each package contains:
            - Binary executable
            - Configuration file template
            - Startup script
            - Comprehensive README
            
            ### ğŸ”§ Installation
            
            1. Download and extract
            2. Edit configuration file
            3. Run startup script
            
            That's it! No compilation or dependencies needed.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
